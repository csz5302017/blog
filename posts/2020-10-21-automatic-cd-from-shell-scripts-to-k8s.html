<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自动化部署: 从脚本到 K8s | wxsm&#39;s space</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" size="200x200" href="favicon-iphone.png">
    <link rel="alternate" type="application/rss+xml" href="https://wxsm.space/rss.xml" title="wxsm&#39;s space RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://wxsm.space/feed.atom" title="wxsm&#39;s space Atom Feed">
    <link rel="alternate" type="application/json" href="https://wxsm.space/feed.json" title="wxsm&#39;s space JSON Feed">
    <meta name="description" content="Just another personal blog.">
    <meta name="google-site-verification" content="ekuL5J7xK1IdFtP13v3KxpuGKnYS1oCT9PvZdjYm8Eg">
    
    <link rel="preload" href="/assets/css/0.styles.0b73a1a5.css" as="style"><link rel="preload" href="/assets/js/app.6cfc030a.js" as="script"><link rel="preload" href="/assets/js/4.93b87abf.js" as="script"><link rel="preload" href="/assets/js/1.89483f76.js" as="script"><link rel="preload" href="/assets/js/131.9cec48b5.js" as="script"><link rel="prefetch" href="/assets/js/10.ab04745f.js"><link rel="prefetch" href="/assets/js/100.edb64ecf.js"><link rel="prefetch" href="/assets/js/101.1010310d.js"><link rel="prefetch" href="/assets/js/102.511df75d.js"><link rel="prefetch" href="/assets/js/103.16e9cb35.js"><link rel="prefetch" href="/assets/js/104.7f8ddf0f.js"><link rel="prefetch" href="/assets/js/105.0a9270d2.js"><link rel="prefetch" href="/assets/js/106.98d28896.js"><link rel="prefetch" href="/assets/js/107.19272619.js"><link rel="prefetch" href="/assets/js/108.2f03290c.js"><link rel="prefetch" href="/assets/js/109.34d5274f.js"><link rel="prefetch" href="/assets/js/11.789c3d3f.js"><link rel="prefetch" href="/assets/js/110.981d94b7.js"><link rel="prefetch" href="/assets/js/111.4a987be8.js"><link rel="prefetch" href="/assets/js/112.68d3196c.js"><link rel="prefetch" href="/assets/js/113.c7e5d127.js"><link rel="prefetch" href="/assets/js/114.ee3f3722.js"><link rel="prefetch" href="/assets/js/115.be2b9699.js"><link rel="prefetch" href="/assets/js/116.5c80bfe3.js"><link rel="prefetch" href="/assets/js/117.f88a25dd.js"><link rel="prefetch" href="/assets/js/118.a3c12cf6.js"><link rel="prefetch" href="/assets/js/119.dce263a5.js"><link rel="prefetch" href="/assets/js/12.4b8d379b.js"><link rel="prefetch" href="/assets/js/120.47ddd7b8.js"><link rel="prefetch" href="/assets/js/121.4e591df0.js"><link rel="prefetch" href="/assets/js/122.5c93955e.js"><link rel="prefetch" href="/assets/js/123.a474eccb.js"><link rel="prefetch" href="/assets/js/124.7eea214b.js"><link rel="prefetch" href="/assets/js/125.81d67a4c.js"><link rel="prefetch" href="/assets/js/126.ad1b502d.js"><link rel="prefetch" href="/assets/js/127.8a0f42e6.js"><link rel="prefetch" href="/assets/js/128.29add6fe.js"><link rel="prefetch" href="/assets/js/129.73908fd7.js"><link rel="prefetch" href="/assets/js/13.159fc0df.js"><link rel="prefetch" href="/assets/js/130.c6b02154.js"><link rel="prefetch" href="/assets/js/132.49db2327.js"><link rel="prefetch" href="/assets/js/133.00073acc.js"><link rel="prefetch" href="/assets/js/134.ed8e0fe8.js"><link rel="prefetch" href="/assets/js/135.6f042a42.js"><link rel="prefetch" href="/assets/js/136.250fb5df.js"><link rel="prefetch" href="/assets/js/137.c0e72bfb.js"><link rel="prefetch" href="/assets/js/138.46dd9692.js"><link rel="prefetch" href="/assets/js/14.30623d81.js"><link rel="prefetch" href="/assets/js/15.e2293de2.js"><link rel="prefetch" href="/assets/js/16.22b543e1.js"><link rel="prefetch" href="/assets/js/17.905a27bb.js"><link rel="prefetch" href="/assets/js/18.0baf70db.js"><link rel="prefetch" href="/assets/js/19.1c3030a4.js"><link rel="prefetch" href="/assets/js/20.c3f86680.js"><link rel="prefetch" href="/assets/js/21.1da78550.js"><link rel="prefetch" href="/assets/js/22.9f4af9b3.js"><link rel="prefetch" href="/assets/js/23.9ed436d8.js"><link rel="prefetch" href="/assets/js/24.8a42d96d.js"><link rel="prefetch" href="/assets/js/25.523c6fc4.js"><link rel="prefetch" href="/assets/js/26.7414f67e.js"><link rel="prefetch" href="/assets/js/27.0b301082.js"><link rel="prefetch" href="/assets/js/28.e0f2a09e.js"><link rel="prefetch" href="/assets/js/29.761d4600.js"><link rel="prefetch" href="/assets/js/30.4fec090b.js"><link rel="prefetch" href="/assets/js/31.2637b20f.js"><link rel="prefetch" href="/assets/js/32.8cce2838.js"><link rel="prefetch" href="/assets/js/33.04deb20e.js"><link rel="prefetch" href="/assets/js/34.037decd9.js"><link rel="prefetch" href="/assets/js/35.723305f1.js"><link rel="prefetch" href="/assets/js/36.fe6550c8.js"><link rel="prefetch" href="/assets/js/37.a23d1c3a.js"><link rel="prefetch" href="/assets/js/38.aa41d681.js"><link rel="prefetch" href="/assets/js/39.e10c9e15.js"><link rel="prefetch" href="/assets/js/40.cd3ceb00.js"><link rel="prefetch" href="/assets/js/41.64cba4ba.js"><link rel="prefetch" href="/assets/js/42.30b70a81.js"><link rel="prefetch" href="/assets/js/43.37583c37.js"><link rel="prefetch" href="/assets/js/44.5e69afc7.js"><link rel="prefetch" href="/assets/js/45.3958b434.js"><link rel="prefetch" href="/assets/js/46.f6bb84f5.js"><link rel="prefetch" href="/assets/js/47.f9a32233.js"><link rel="prefetch" href="/assets/js/48.b62e6ee9.js"><link rel="prefetch" href="/assets/js/49.372da33b.js"><link rel="prefetch" href="/assets/js/5.3bcab57c.js"><link rel="prefetch" href="/assets/js/50.cad81ba6.js"><link rel="prefetch" href="/assets/js/51.c1fa0b0d.js"><link rel="prefetch" href="/assets/js/52.4a8bba81.js"><link rel="prefetch" href="/assets/js/53.b427954e.js"><link rel="prefetch" href="/assets/js/54.448d5201.js"><link rel="prefetch" href="/assets/js/55.76ec48c7.js"><link rel="prefetch" href="/assets/js/56.d6e69358.js"><link rel="prefetch" href="/assets/js/57.28eeb571.js"><link rel="prefetch" href="/assets/js/58.636a9b5b.js"><link rel="prefetch" href="/assets/js/59.ea737351.js"><link rel="prefetch" href="/assets/js/6.0b15f6a7.js"><link rel="prefetch" href="/assets/js/60.71561f99.js"><link rel="prefetch" href="/assets/js/61.ad869f67.js"><link rel="prefetch" href="/assets/js/62.708d1b48.js"><link rel="prefetch" href="/assets/js/63.7a6b0770.js"><link rel="prefetch" href="/assets/js/64.c30bee6f.js"><link rel="prefetch" href="/assets/js/65.86f85ec4.js"><link rel="prefetch" href="/assets/js/66.940160c0.js"><link rel="prefetch" href="/assets/js/67.0b1a3a8c.js"><link rel="prefetch" href="/assets/js/68.fa3f313f.js"><link rel="prefetch" href="/assets/js/69.13771080.js"><link rel="prefetch" href="/assets/js/7.3ac6269f.js"><link rel="prefetch" href="/assets/js/70.865c5fcb.js"><link rel="prefetch" href="/assets/js/71.14ed2e6e.js"><link rel="prefetch" href="/assets/js/72.d358bcbd.js"><link rel="prefetch" href="/assets/js/73.4f80377c.js"><link rel="prefetch" href="/assets/js/74.6bd59ba9.js"><link rel="prefetch" href="/assets/js/75.0644e837.js"><link rel="prefetch" href="/assets/js/76.187e10c1.js"><link rel="prefetch" href="/assets/js/77.c0cbd856.js"><link rel="prefetch" href="/assets/js/78.bd9a9221.js"><link rel="prefetch" href="/assets/js/79.bd8af51d.js"><link rel="prefetch" href="/assets/js/8.55b06485.js"><link rel="prefetch" href="/assets/js/80.c3a22465.js"><link rel="prefetch" href="/assets/js/81.208d2216.js"><link rel="prefetch" href="/assets/js/82.cd62e4b6.js"><link rel="prefetch" href="/assets/js/83.a9eb35e5.js"><link rel="prefetch" href="/assets/js/84.719b32b2.js"><link rel="prefetch" href="/assets/js/85.09e6f534.js"><link rel="prefetch" href="/assets/js/86.13fe7503.js"><link rel="prefetch" href="/assets/js/87.a7004328.js"><link rel="prefetch" href="/assets/js/88.6408f1f9.js"><link rel="prefetch" href="/assets/js/89.1c49bc09.js"><link rel="prefetch" href="/assets/js/9.bad3ab49.js"><link rel="prefetch" href="/assets/js/90.eee956c1.js"><link rel="prefetch" href="/assets/js/91.d5cfc841.js"><link rel="prefetch" href="/assets/js/92.e2bbcb0f.js"><link rel="prefetch" href="/assets/js/93.774c5a59.js"><link rel="prefetch" href="/assets/js/94.af84d334.js"><link rel="prefetch" href="/assets/js/95.0b7c3d44.js"><link rel="prefetch" href="/assets/js/96.1472868a.js"><link rel="prefetch" href="/assets/js/97.a9e54459.js"><link rel="prefetch" href="/assets/js/98.fb4b3815.js"><link rel="prefetch" href="/assets/js/99.00b68490.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.407c587a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0b73a1a5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-37172400><main class="page" data-v-37172400><div class="theme-default-content content__default" data-v-37172400><div class="space-header" data-v-37172400><a href="/" class="home-link router-link-active">wxsm's space</a> <div class="links"><span><a href="/" class="site-link router-link-active">home</a> <span>&nbsp;&nbsp;&middot;&nbsp;&nbsp;</span></span><span><a href="/projects/" class="site-link">projects</a> <span>&nbsp;&nbsp;&middot;&nbsp;&nbsp;</span></span><span><a href="/about/" class="site-link">about</a> <span>&nbsp;&nbsp;&middot;&nbsp;&nbsp;</span></span><span><a href="/links/" class="site-link">links</a> <!----></span></div> <div class="search-box-container"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div> <div class="title" data-v-37172400><h3 data-v-37172400>Oct 21, 2020</h3> <h1 data-v-37172400>自动化部署: 从脚本到 K8s</h1></div> <div class="content__default" data-v-37172400><p><img src="https://static.wxsm.space/others/kubernetes-logo.png" alt="k8-logo" width="500"></p> <p>如果公司有专业运维，项目的部署上线过程一般来说开发者都不会接触到。但是很不幸，我所在的团队没有独立的运维团队，所以一切都得靠自己（与同事）。</p> <p>以下都只是工作中逐步优化得到的经验总结，并且只以 Node.js 程序部署为例。</p> <h2 id="部署上线的原始版本"><a href="#部署上线的原始版本" class="header-anchor">#</a> 部署上线的原始版本</h2> <h3 id="流程图"><a href="#流程图" class="header-anchor">#</a> 流程图</h3> <p>举例：服务器使用 PM2 管理部署。纯手工操作：</p> <!----><h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>整个过程耗时 10~30 分钟不等。</p> <p>优点：</p> <ol><li>不依赖任何工具/系统</li> <li>适用于任何分支</li></ol> <p>缺点：</p> <ol><li>麻烦、耗时</li> <li>易出错</li> <li>无法持续部署</li> <li>多节点怎么办？</li></ol> <h2 id="基于-ci-系统的全自动版本"><a href="#基于-ci-系统的全自动版本" class="header-anchor">#</a> 基于 CI 系统的全自动版本</h2> <p>一般来说企业都会有一套 CI 系统，可能是传统的 Jenkins，也可能是 Gitlab CI / Github Actions / Travis CI / Circle CI 等等。它们之间大同小异，都是通过某种方式写好若干份配置文件，当某些操作（如 git push）触发时以及满足某种条件（如当前分支为发布分支，或提交了 tag 等）执行某些任务。</p> <p>这里使用 Gitlab CI 举例，CI/CD 通过 Gitlab Runner 完成，服务器使用 PM2 管理部署。</p> <h3 id="流程图-2"><a href="#流程图-2" class="header-anchor">#</a> 流程图</h3> <!----><h3 id="技术细节"><a href="#技术细节" class="header-anchor">#</a> 技术细节</h3> <p>配置文件 <code>.gitlab-ci.yml</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">image</span><span class="token punctuation">:</span> node

<span class="token key atrule">before_script</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> yarn <span class="token punctuation">-</span><span class="token punctuation">-</span>frozen<span class="token punctuation">-</span>lockfile

<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> test
  <span class="token punctuation">-</span> build
  <span class="token punctuation">-</span> deploy

<span class="token comment"># 代码测试</span>
<span class="token key atrule">test</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> npm run lint
    <span class="token punctuation">-</span> npm run test
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node

<span class="token comment"># 前端代码构建测试</span>
<span class="token key atrule">build-frontend</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> npm run build
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node

<span class="token comment"># 发布 dev 环境，其他环境略</span>
<span class="token key atrule">deploy-dev</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token comment"># 仅在 release-dev 分支上执行改任务</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> release<span class="token punctuation">-</span>dev 
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> npm run build<span class="token punctuation">:</span>dev
    <span class="token punctuation">-</span> scp <span class="token punctuation">-</span>r . user@host<span class="token punctuation">:</span>~/path/to/deploy
    <span class="token punctuation">-</span> ssh user@@host &quot;
        pm2 delete <span class="token punctuation">-</span>s frontend <span class="token punctuation">|</span><span class="token punctuation">|</span> true <span class="token important">&amp;&amp;</span>
        pm2 delete <span class="token punctuation">-</span>s server <span class="token punctuation">|</span><span class="token punctuation">|</span> true <span class="token important">&amp;&amp;</span>
        pm2 serve /path/to/deploy/frontend/ 8080 <span class="token punctuation">-</span><span class="token punctuation">-</span>name frontend <span class="token important">&amp;&amp;</span>
        yarn <span class="token punctuation">-</span><span class="token punctuation">-</span>cwd /path/to/deploy/server/ <span class="token important">&amp;&amp;</span>
        pm2 start /path/to/deploy/server/server.js <span class="token punctuation">-</span><span class="token punctuation">-</span>name server&quot;
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node

<span class="token comment"># ...</span>
</code></pre></div><h3 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h3> <p>优点：</p> <ol><li>全过程仅依赖 Gitlab 与 Gitlab Runner （基于或不基于容器）</li> <li>全自动测试，提交到发布分支则全自动部署，测试失败的代码不会被部署</li></ol> <p>缺点：</p> <ol><li>需要在 Gitlab 上配置远程机器的登录凭证（账号/密码），或在 Runner 机器上配置 ssh key</li> <li>Runner 会拥有部署机器的访问权限</li> <li>多节点？运维？</li></ol> <h2 id="gitlab-与-agent-平台结合的半自动版本"><a href="#gitlab-与-agent-平台结合的半自动版本" class="header-anchor">#</a> Gitlab 与 Agent 平台结合的半自动版本</h2> <p>为了解决上述 Runner 机器权限过高的问题，这个版本引入了 Agent 平台的概念。每个企业使用的平台可能有所区别，有可能是自研的（如我司），也有可能是外部提供的的（如「宝塔」）。但大体功能基本一致。</p> <p>该版本中：</p> <ol><li>CI 通过 Gitlab Runner 完成。任务完成后会将代码打包，并放置于服务器上的某个位置，该位置通过 Nginx 暴露（仅对内）</li> <li>CD 通过 Agent 平台完成。Agent 从上一步暴露的地址中下载代码，解压缩并放置到指定位置，重启 PM2 服务</li></ol> <h3 id="流程图-3"><a href="#流程图-3" class="header-anchor">#</a> 流程图</h3> <!----><h3 id="总结-3"><a href="#总结-3" class="header-anchor">#</a> 总结</h3> <p>这一个版本中，CI 系统的配置简化了，去除部署部分的任务即可。至于 Agent 平台的配置方式，可能是一个完整的 bash 脚本，也可能是其它配置，就不在此展开了。</p> <p>优点：</p> <ol><li>CI 过程全自动</li> <li>CI/CD 权限解耦</li> <li>适用于各种分支</li></ol> <p>缺点：</p> <ol><li>非线上发布过程也需要手动完成，麻烦</li> <li>严重依赖 Agent 平台</li> <li>运维？</li></ol> <h2 id="gitlab-与-k8s-结合的全自动版本-v1"><a href="#gitlab-与-k8s-结合的全自动版本-v1" class="header-anchor">#</a> Gitlab 与 k8s 结合的全自动版本 v1</h2> <p>k8s (kubernetes) 是一个容器集群部署管理系统。</p> <p>容器基础知识：</p> <ol><li><a href="https://docs.docker.com/get-started/overview/#docker-objects" target="_blank" rel="noopener noreferrer">镜像 Image<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.docker.com/get-started/overview/#docker-objects" target="_blank" rel="noopener noreferrer">容器 Container<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <p>k8s 基础知识：</p> <ol><li><a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">工作单元 pod<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/" target="_blank" rel="noopener noreferrer">服务 service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/" target="_blank" rel="noopener noreferrer">节点 node<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kubernetes.io/zh/docs/tasks/manage-kubernetes-objects/kustomization/" target="_blank" rel="noopener noreferrer">Kustomize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h3 id="流程图-4"><a href="#流程图-4" class="header-anchor">#</a> 流程图</h3> <!----><h3 id="技术细节-2"><a href="#技术细节-2" class="header-anchor">#</a> 技术细节</h3> <p><code>Dockerfile</code>:</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> alpine

<span class="token keyword">RUN</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache <span class="token punctuation">-</span><span class="token punctuation">-</span>update nodejs nodejs<span class="token punctuation">-</span>npm yarn
<span class="token keyword">RUN</span> adduser <span class="token punctuation">-</span>u 1000 <span class="token punctuation">-</span>D app <span class="token punctuation">-</span>h /data

<span class="token keyword">USER</span> app

<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=app start.sh /data/start.sh

<span class="token keyword">WORKDIR</span> /data

<span class="token keyword">EXPOSE</span> 8000
<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span> <span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/data/start.sh&quot;</span> <span class="token punctuation">]</span>
</code></pre></div><p><code>start.sh</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/usr/bin/env sh</span>

<span class="token comment"># 从文件服务器获取该版本包</span>
<span class="token assign-left variable">VERSION_DEPLOY_HTTPCODE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> -s <span class="token string">&quot;https://xxx/<span class="token variable">${VERSION}</span>&quot;</span> -o pkg.tgz -w <span class="token string">&quot;%{http_code}&quot;</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$VERSION_DEPLOY_HTTPCODE</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;200&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;using version: <span class="token variable">${VERSION}</span>&quot;</span>
    <span class="token function">tar</span> zxf pkg.tgz
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;version package not exist: <span class="token variable">${VERSION}</span>&quot;</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token function">sh</span> deploy.sh
</code></pre></div><p>kill 实现：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// koa</span>
router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/api/kill'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">IS_PROD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'ok'</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="总结-4"><a href="#总结-4" class="header-anchor">#</a> 总结</h3> <p>优点：</p> <ol><li>CI 过程全自动</li> <li>非线上环境 CD 全自动，线上环境 CD 手动指定版本，兼顾方便与安全</li> <li>无需配置远程机器权限</li></ol> <p>缺点：</p> <ol><li>k8s 使用原始镜像启动 pod，拉取代码与安装依赖的过程非常耗时（每次启动都是全新镜像，无缓存）。</li> <li>CD 过程不确定性较多，存在代码文件服务器故障、依赖安装故障等风险。</li> <li>kill 指令发出后服务会暂时不可用。</li> <li>多节点？</li></ol> <h2 id="gitlab-与-k8s-结合的全自动版本-v2"><a href="#gitlab-与-k8s-结合的全自动版本-v2" class="header-anchor">#</a> Gitlab 与 k8s 结合的全自动版本 v2</h2> <p>为了解决上面的问题 3/4，引入 <code>Consul</code> 对 CI/CD 过程做出了改进。</p> <p>Consul 是为基础设施提供服务发现和服务配置的工具，包含多种功能，这次用到了其中两个功能：</p> <ol><li>服务发现</li> <li>健康检查</li></ol> <h3 id="流程图-5"><a href="#流程图-5" class="header-anchor">#</a> 流程图</h3> <!----><h3 id="技术细节-3"><a href="#技术细节-3" class="header-anchor">#</a> 技术细节</h3> <p>这个流程里面涉及到几个问题：</p> <h4 id="关于-逐个发送-kill-指令"><a href="#关于-逐个发送-kill-指令" class="header-anchor">#</a> 关于“逐个发送 kill 指令”</h4> <p>虽然通过 Consul 可以获取到所有运行中 pod 的 ip 及端口，但是如果集中发送 kill 命令仍然会造成服务不可用。目前我司服务端的 CI 就有这个问题，他们虽然每个 kill  会有一段固定时间的 sleep 间隔，但无法保证下一个 kill 发出时上个服务时候已重启完毕。</p> <p>为了解决这个问题，我写了一个脚本。</p> <p>流程：</p> <!----><p>代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token comment">/**
 * 此脚本在gitlab-runner中作为CI的最后一步执行
 * 在非线上环境中可以对容器进行逐个重启，尽量减少downtime
 */</span>

<span class="token comment">// 确保线上环境不执行此脚本</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">request</span> <span class="token punctuation">(</span><span class="token parameter">host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      hostname<span class="token operator">:</span> host<span class="token punctuation">,</span>
      port<span class="token operator">:</span> port<span class="token punctuation">,</span>
      path<span class="token operator">:</span> path<span class="token punctuation">,</span>
      method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span>
      res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        data <span class="token operator">+=</span> chunk
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          status<span class="token operator">:</span> res<span class="token punctuation">.</span>statusCode<span class="token punctuation">,</span>
          data
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sleep</span> <span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 各环境的consul请求地址</span>
  <span class="token comment">// 具体使用时需要填入指定 host 与 port</span>
  <span class="token keyword">const</span> apiMap <span class="token operator">=</span> <span class="token punctuation">{</span>
    development<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">,</span> <span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    qa<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">,</span> <span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pp<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">,</span> <span class="token string">'port'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 从consul获取已注册pod列表</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> apiMap<span class="token punctuation">[</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>api<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> api<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> api<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res <span class="token operator">||</span> <span class="token operator">!</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'consul find service failed, exiting...'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'consul raw:'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> pods <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>v<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> v<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>Port<span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'consul services:'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pods<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 循环杀进程</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pods<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pod <span class="token operator">=</span> pods<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------------'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pod<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// 重启一个pod</span>
    <span class="token keyword">const</span> killRes <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pod<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/kill</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>killRes <span class="token operator">&amp;&amp;</span> killRes<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// kill返回成功，这个节点原本是活着的才继续监测它的状态</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'killed.'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> pods<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 已经杀完了最后一个pod，无需继续等待重启，直接退出</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> isServerUp <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">// let isFrontendUp = false</span>
      <span class="token comment">// 每个pod最多检测12次（2分钟），超过时间则放弃，直接重启下一个pod</span>
      <span class="token keyword">let</span> tryTimes <span class="token operator">=</span> <span class="token number">12</span>
      <span class="token comment">// 循环检测是否重启成功</span>
      <span class="token keyword">do</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'waiting for pod up...'</span><span class="token punctuation">,</span> tryTimes<span class="token punctuation">)</span>
        <span class="token comment">// 每10秒检测一次</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'check if pod up...'</span><span class="token punctuation">)</span>
        <span class="token comment">// 如果返回200表示已服务已重新启动</span>
        <span class="token keyword">const</span> serverRes <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pod<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/health-check</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        isServerUp <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>serverRes <span class="token operator">&amp;&amp;</span> serverRes<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'pod server up:'</span><span class="token punctuation">,</span> isServerUp<span class="token punctuation">)</span>
        <span class="token comment">// 等待 k8s readinessProbe 开始，节点被认为已存活，则可以对外访问</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isServerUp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> waitSecondsStr <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">WAIT_FOR_PROBE_SECONDS</span> <span class="token operator">||</span> <span class="token string">'10'</span>
          <span class="token keyword">const</span> waitSeconds <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>waitSecondsStr<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>waitSeconds<span class="token punctuation">)</span> <span class="token operator">||</span> waitSeconds <span class="token operator">&gt;=</span> <span class="token number">120</span> <span class="token operator">||</span> waitSeconds <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 最大等待120秒，超过视为参数错误</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WAIT_FOR_PROBE_SECONDS is invalid, skip waiting for prob.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pod is up internally, but need to wait for live probe (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>waitSeconds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s)...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span>waitSeconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>isServerUp <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>tryTimes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'kill failed, skip.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>在 gitlab-ci 的最后一步执行此脚本：</p> <p><code>.gitlab-ci.yml</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># ...</span>
<span class="token key atrule">deploy-dev</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> release<span class="token punctuation">-</span>dev
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ./build.sh
    <span class="token punctuation">-</span> NODE_ENV=development SERVICE_NAME=some<span class="token punctuation">-</span>name npm_config_registry=http<span class="token punctuation">:</span>//private.registry.com npx restart<span class="token punctuation">-</span>project<span class="token punctuation">-</span>via<span class="token punctuation">-</span>consul<span class="token punctuation">-</span>script@latest
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node
<span class="token comment"># ...</span>
</code></pre></div><h4 id="关于-解注册所有同名服务-与-注册自己"><a href="#关于-解注册所有同名服务-与-注册自己" class="header-anchor">#</a> 关于“解注册所有同名服务”与“注册自己”</h4> <p>项目内部使用 <a href="https://www.npmjs.com/package/consul" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/consul<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来与 Consul 通信。</p> <p>需要“解注册所有同名服务”的原因：</p> <p>Consul 在注册服务时并没有类似“主键”的概念，一个 Consul 有多个 Agent，也就是说相同 ip、相同 id 的服务可能会在不同 Agent 上被注册多次，并且由于 pod 的 ip 是短暂的，每次重启 pod 获得的 ip 可能会有差异，因此如果不进行解注册就会导致从 Consul 上获得的服务与现实正在运行的不一致。</p> <p>流程：</p> <!----><h3 id="总结-5"><a href="#总结-5" class="header-anchor">#</a> 总结</h3> <p>优点：</p> <ol><li>CI 过程全自动</li> <li>非线上环境 CD 全自动，线上环境CD手动指定版本，兼顾方便与安全</li> <li>无需配置远程机器权限</li> <li>支持多节点</li> <li>高可用性的重启</li></ol> <p>缺点：</p> <ol><li>k8s 使用原始镜像启动 pod，拉取代码与安装依赖的过程非常耗时（每次启动都是全新镜像，无缓存）。</li> <li>CD 过程不确定性较多，存在代码文件服务器故障、依赖安装故障等风险。</li></ol> <p>为什么会做成这个样子呢，因为我司的服务端使用 golang 是走的这一套流程，但是使用 golang 打包编译出的是一个二进制文件，镜像直接拉取就可以启动，不需要依赖安装等步骤。因此他们使用这种方式的缺点并不明显。但是对于 Nodejs 程序来说，这依然是一个较大缺陷。</p> <h2 id="gitlab-与-k8s-结合的全自动版本-v3"><a href="#gitlab-与-k8s-结合的全自动版本-v3" class="header-anchor">#</a> Gitlab 与 k8s 结合的全自动版本 v3</h2> <p>为了解决上面的问题 1/2，这个版本更改了代码部署到 k8s 的方式：使用完整的预构建镜像，而不是空白镜像。</p> <h3 id="流程图-6"><a href="#流程图-6" class="header-anchor">#</a> 流程图</h3> <!----><h3 id="技术细节-4"><a href="#技术细节-4" class="header-anchor">#</a> 技术细节</h3> <p><code>build.sh</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;Process: 构建 Docker 镜像...&quot;</span>
docker build -t wohx-<span class="token variable">${PROJECT_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${COMMIT_SHA}</span> <span class="token builtin class-name">.</span>
docker tag wohx-<span class="token variable">${PROJECT_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${COMMIT_SHA}</span> private.registry.com/<span class="token variable">${PROJECT_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${COMMIT_SHA}</span>
docker tag wohx-<span class="token variable">${PROJECT_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${COMMIT_SHA}</span> private.registry.com/<span class="token variable">${PROJECT_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${BRANCH}</span>-latest

<span class="token builtin class-name">echo</span> <span class="token string">&quot;Process: 上传 Docker 镜像...&quot;</span>
docker push private.registry.com/<span class="token variable">${PROJECT_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${COMMIT_SHA}</span>
docker push private.registry.com/<span class="token variable">${PROJECT_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${BRANCH}</span>-latest
</code></pre></div><p><code>Dockerfile</code>:</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> alpine
<span class="token keyword">RUN</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache <span class="token punctuation">-</span><span class="token punctuation">-</span>update nodejs nodejs<span class="token punctuation">-</span>npm yarn
<span class="token keyword">RUN</span> adduser <span class="token punctuation">-</span>u 1000 <span class="token punctuation">-</span>D app <span class="token punctuation">-</span>h /data
<span class="token keyword">USER</span> app
<span class="token keyword">WORKDIR</span> /data
<span class="token keyword">EXPOSE</span> 8000
<span class="token comment"># server 确保在 yarn.lock 与 package.json 没有改变的情况下，此层能被缓存</span>
<span class="token comment"># frontend 的 node_modules 已在 .dockerignore 中忽略，无需关注</span>
<span class="token keyword">RUN</span> mkdir ./server &amp;&amp; mkdir <span class="token punctuation">-</span>p ./frontend/dist
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=app server/yarn.lock server/package.json ./server/
<span class="token keyword">RUN</span> yarn <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>engines <span class="token punctuation">-</span><span class="token punctuation">-</span>cwd /data/server/
<span class="token comment"># 启动脚本</span>
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=app ./start.sh ./
<span class="token comment"># server 源代码层</span>
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=app ./server ./server/
<span class="token comment"># frontend dist 层</span>
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=app ./frontend/dist ./frontend/dist
<span class="token comment"># entry</span>
<span class="token comment"># CMD [ &quot;node&quot;, &quot;./server/server.js&quot; ]</span>
<span class="token comment"># start.sh 允许 k8s 自定义启动逻辑</span>
<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span> <span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/data/start.sh&quot;</span> <span class="token punctuation">]</span>
</code></pre></div><h3 id="总结-6"><a href="#总结-6" class="header-anchor">#</a> 总结</h3> <p>优点：</p> <ol><li>CI过程全自动</li> <li>非线上环境CD全自动，线上环境CD手动指定版本，兼顾方便与安全</li> <li>无需配置远程机器权限</li> <li>支持多节点</li> <li>高可用性的重启</li> <li>预构建的镜像，CD 阶段开箱即用，无任何依赖</li></ol> <p>缺点：</p> <ol><li>为了使每个 pod 能够获得一个稳定的名称（用于在 Consul 中注册、解注册），部署类型使用了 Statefulset，因此带来了一些本来不需要的特性。</li></ol></div> <br data-v-37172400> <div class="last-updated" data-v-37172400><span class="prefix" data-v-37172400>Last Updated:</span> <span class="time" data-v-37172400>3 months ago</span></div>  <div class="space-footer" data-v-a298b7ba data-v-37172400><p class="footer-text" data-v-a298b7ba>© 2021 wxsm</p> <p class="footer-text" data-v-a298b7ba>
    Powered by <a href="https://vuepress.vuejs.org/" target="_blank" data-v-a298b7ba>VuePress</a>
     · 
    Theme by <a href="https://github.com/wxsms/vuepress-theme-mini" target="_blank" data-v-a298b7ba>mini</a></p></div></div></main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.6cfc030a.js" defer></script><script src="/assets/js/4.93b87abf.js" defer></script><script src="/assets/js/1.89483f76.js" defer></script><script src="/assets/js/131.9cec48b5.js" defer></script>
  </body>
</html>
